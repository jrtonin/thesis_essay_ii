---
title: "Essay II"
author: "Jo√£o Ricardo Tonin"
date: "03/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "")
getwd()

{ 
  # Check if the packages that we need are installed
  want = c("tidyverse", "plm", "texreg", "lmtest", "tibble")
  have = want %in% rownames(installed.packages())
  # Install the packages that we miss
  if ( any(!have) ) { install.packages( want[!have] ) }
  # Load the packages
  junk <- lapply(want, library, character.only = T)
  # Remove the objects we created
  rm(have, want, junk)
} # Import packages

```

```{r reading_databases, include=FALSE, echo=TRUE}

# reading databases
BASE1 = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/BASE1_EssayI.rds")) %>%
  filter(year >= 2019)

BASE2 = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/BASE2_EssayI.rds")) %>% 
  filter(year >= 2019)

LBASE1 = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/LBASE1_EssayI.rds")) %>% 
  filter(year >= 2019)

LBASE2 = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/LBASE2_EssayI.rds")) %>% 
  filter(year >= 2019)

BASE = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/BASE_EssayI.rds")) %>% 
  filter(year >= 2019)

FINAL = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/FINAL_EssayI.rds")) %>% 
  filter(year >= 2019)

HAUSMAN = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/HAUSMAN_instrument.rds"))

ESTBAN = readRDS(url("https://github.com/jrtonin/thesis_essay_ii/raw/main/data/ESTBAN_instrument.rds"))
                                                                
```

```{r base_transformation, include=FALSE}

# importing aerodromo database
aerodromos = read_delim(url("https://raw.githubusercontent.com/jrtonin/thesis_essay_ii/main/data/aerodromos.csv"), 
                        delim = ";", escape_double = FALSE, 
                        locale = locale(encoding = "ISO-8859-1"), 
                        trim_ws = TRUE)

# importing lat and lon by city
urlfile = "https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/main/csv/municipios.csv"
latlon = read_csv(url(urlfile)) %>%
  mutate(code_city = codigo_ibge,
         lat = latitude,
         lon = longitude,
         city = nome,
         uf_code = codigo_uf) %>% 
  dplyr::select(code_city, city, uf_code, lat, lon)

# including IBGE code and lat and lon
aerodromos = aerodromos %>%
  left_join(latlon, by = c("city", "uf_code"))

# changing NA's
 HAUSMAN[is.na(HAUSMAN)] = 0

# merging ESTBAN and HAUSMAN data
LBASE1a = LBASE1 %>%
  left_join(aerodromos %>% dplyr::select(code, code_city), by = c("air_dep" = "code")) %>%
  mutate(code_city_dep = code_city) %>% dplyr::select(-code_city) %>%
  left_join(aerodromos %>% dplyr::select(code, code_city), by = c("air_arr" = "code")) %>%
  mutate(code_city_arr = code_city) %>% dplyr::select(-code_city) %>% 
  left_join(ESTBAN %>% 
            mutate(year = as.double(str_sub(time, 1,4)),
                   month = as.double(str_sub(time, 5, 6))) %>%
              dplyr::select(year, month, code_city, nbank, deposits, credit_loan), 
            by = c("code_city_dep" = "code_city", "year" = "year", "month" = "month")) %>%
  mutate(ldep_nbank = log(nbank),
         ldep_deposits = log(deposits+1),
         ldep_credit_loan = log(credit_loan)) %>% 
  dplyr::select(-nbank, -deposits, -credit_loan) %>%
  left_join(ESTBAN %>% 
            mutate(year = as.double(str_sub(time, 1,4)),
                   month = as.double(str_sub(time, 5, 6))) %>%
              dplyr::select(year, month, code_city, nbank, deposits, credit_loan), 
            by = c("code_city_arr" = "code_city", "year" = "year", "month" = "month")) %>%
  mutate(larr_nbank = log(nbank),
         larr_deposits = log(deposits+1),
         larr_credit_loan = log(credit_loan)) %>% 
  dplyr::select(-nbank, -deposits, -credit_loan) %>%
  mutate(nbank = (larr_nbank*ldep_nbank)^1/2,
         deposits = (ldep_deposits*larr_deposits)^1/2,
         credit_loan = (ldep_credit_loan*larr_credit_loan)^1/2) %>%
  dplyr::select(-larr_nbank, -larr_deposits, -larr_credit_loan, 
                -ldep_nbank, -ldep_deposits, -ldep_credit_loan) %>%
  mutate(id = sequence(n())) %>% 
  left_join(HAUSMAN, by = c("id")) %>%
  mutate(m150RouteHHI = log(m150RouteHHI+1), 
         m300RouteHHI = log(m300RouteHHI+1),
         m500RouteHHI = log(m500RouteHHI+1),
         m150DepHHI = log(m150DepHHI+1),
         m300DepHHI = log(m300DepHHI+1),
         m500DepHHI = log(m500DepHHI+1),
         m150seat_dem = log(m150seat_dem+1),
         m300seat_dem = log(m300seat_dem+1),
         m500seat_dem = log(m500seat_dem+1),
         m150price = log(m150price+1),
         m300price = log(m300price+1),
         m500price = log(m500price+1),
         m150RouteShare = log(m150RouteShare+1), 
         m300RouteShare = log(m300RouteShare+1),
         m500RouteShare = log(m500RouteShare+1))

# changing NA's
 LBASE1a[is.na(LBASE1a)] = 0
```

```{r equation_new, warning=FALSE, message=FALSE, error=FALSE, include=TRUE, echo = FALSE}

# organizing database
dLBASE1 = LBASE1a %>% 
  arrange(year, month, air_dep, air_arr, airline) %>%
  group_by(year, month) %>% 
  mutate(id = sequence(n()),
         time = paste0(year,"/", month)) %>%
  filter(!time %in% c("2019/1", "2019/2", "2019/3"))

# creating group indices' variable
dLBASE1$group = dLBASE1 %>% group_indices(time)

# transforming to panel data
dLBASE1 = pdata.frame(dLBASE1, index = c("id","time")) %>%
  mutate(endo = seat_dem,
         z1 = m150seat_dem,
         z2 = nbank,
         z3 = deposits, 
         z4 = credit_loan,
         z5 = m150price) %>%
  arrange(year, month)


### equations
OLS = price ~ flight_hours + endo
FS = endo ~ flight_hours + z5 
HR = endo ~ flight_hours + fs$residuals
W1 = price ~ flight_hours + endo | . -endo + z5 

pgmm = price ~ lag(price) + flight_hours + endo + aircraft + hubling +  
  tx_seat + tx_dir + MMC + connection + X6.11 + X12.17 + X18.23 |
  lag(endo, 1:20) + lag(price, 2:20) | z2 + z3

```

```{r did_reg, include=FALSE}

# 2SLS

ols = plm(OLS, data = dLBASE1, effect = "time")
fe =  update(ols, effect = "twoways")
ivfe = update(fe, . ~ . | . -endo + z5)

# joining regression results
screenreg(list(ols   = ols,  fe   = fe, ivfe  = ivfe),
               digits = 3, omit.coef = "(Intercept)")

# tests 

## instrument relevance

# first stage: regress endogenous variable with all exogenous variables
fs = plm(FS, data = dLBASE1, effect = "twoways")

# second stage: regress first stage equation without z's variables
instrFtest = waldtest(fs, . ~ . -z5 )
print(instrFtest) # H0: instruments are irrelevants -> needs p_valor < 0,10 


## exogeneity test

# first stage: idem fs estimation

# second stage: regress normal equation with fs$residuals as independent variable
Hausman_reg = plm(HR, data = dLBASE1, effect = "twoways")
print(summary(Hausman_reg))

# third stage: execute Wu-Hausman exogeneity test
HausWutest = waldtest(Hausman_reg,.~.-fs$residuals)
print(HausWutest) # H0: residuals are irrelevants -> needs p_valor > 0.10


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ec2sls

w1 = plm(W1, data = dLBASE1, model = "within")
r1 = update(w1, model = "random", random.method = "nerlove",
            random.dfcor = c(3, 3), inst.method = "baltagi")

# Hausman test
phtest(w1, r1) # H1: one model is inconsistent - p_valor < 0,10 : within


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ht2sls

# ec
ht1r = plm(W1, data = dLBASE1, model = "random", 
           inst.method = "baltagi", random.method = "ht")

# w
ht1w = plm(W1, data = dLBASE1, model = "within", 
           inst.method = "baltagi", random.method = "ht")

# Hausman test
phtest(ht1w, ht1r)

# gmm

gmm1 = pgmm(pgmm, dLBASE1, model = "twosteps", effect="twoways", colapse=TRUE, transformation = "ld")

summary(gmm1)
coef(summary(gmm1))

mtest(gmm1, order = 1)
sargan(gmm1)
mtest(gmm1, order = 2, vcov = vcovHC)
```

```{r gmm_i, include=FALSE, error=TRUE}

# setting directory 
setwd("C:/TESE/GITHUB/thesis_essay_ii/results")

# editing function of organizing database
tabgmm = function(model){
  
  # extracting parameters
  param = as.data.frame(matrix(c(list(model$args$model, 
                                      model$args$effect, model$args$transformation)), 
                             ncol = 1, byrow = TRUE))
  colnames(param) = c("coef")
  row.names(param) = c("model", "effect", "transformation")
  param = param %>% 
    mutate(coef = as.character(coef))
  
  # extracting sargan test statistics
  sargan = sargan(model)
  sargan = as.data.frame(list(round(sargan$statistic, 3), round(sargan$p.value, 3)))
  colnames(sargan) = c("coef","pvalue")
  row.names(sargan) = c("sargan")
  
  # extracting mtest statistics
  mtest = mtest(model, order = 2)
  mtest = as.data.frame(list(round(mtest$statistic, 3), round(mtest$p.value, 3)))
  colnames(mtest) = c("coef","pvalue")
  row.names(mtest) = c("mtest")
  
  # extracting waldtest coef. statistics
  pwaldtest = pwaldtest(model, param = "coef")
  pwaldtest = as.data.frame(list(round(pwaldtest$statistic, 3), round(pwaldtest$p.value, 3)))
  colnames(pwaldtest) = c("coef","pvalue")
  row.names(pwaldtest) = c("Wald coef")
  
  # organizing database
  coef = as.data.frame(coef(summary(model))) %>% 
    mutate(pvalue = round(`Pr(>|z|)`,3),
           coef = round(Estimate,3)) %>%
    select(coef, pvalue) 
  
  # merging dataframes
  res = bind_rows(coef, sargan, mtest, pwaldtest) %>%
    mutate(coef = as.character(coef),
           pvalue = as.character(pvalue)) %>%
    bind_rows(param)
  
  return(res)
}

# editing function of regression gmm model
reggmm = function(equation){
  
  # regressing equation 1
  a11 = pgmm(equation, dLBASE1, model = "onestep", effect="individual")
  
  # tabulation main results
  ra11 = tabgmm(a11)
  colnames(ra11) = c("ra11_c", "ra11_p")
  
  # regressing equation 2
  a12 = pgmm(equation, dLBASE1, model = "onestep", effect="twoways")
  
  # tabulation main results
  ra12 = tabgmm(a12)
  colnames(ra12) = c("ra12_c", "ra12_p")
  
  # regressing equation 3
  a13 = pgmm(equation, dLBASE1, model = "twosteps", effect="individual")
  
  # tabulation main results
  ra13 = tabgmm(a13)
  colnames(ra13) = c("ra13_c", "ra13_p")
  
  # regressing equation 4
  a14 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways")
  
  # tabulation main results
  ra14 = tabgmm(a14)
  colnames(ra14) = c("ra14_c", "ra14_p")
  
  # regressing equation 5
  a15 = pgmm(equation, dLBASE1, model = "twosteps", effect="individual",colapse = TRUE)
  
  # tabulation main results
  ra15 = tabgmm(a15)
  colnames(ra15) = c("ra15_c", "ra15_p")
  
  # regressing equation 6
  a16 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways", colapse = TRUE)
  
  # tabulation main results
  ra16 = tabgmm(a16)
  colnames(ra16) = c("ra16_c", "ra16_p")
  
  # regressing equation 7
  a17 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways", colapse = TRUE, 
           transformation = "ld")
  
  # tabulation main results
  ra17 = tabgmm(a17)
  colnames(ra17) = c("ra17_c", "ra17_p")
  
  # regressing equation 7
  a18 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways", colapse = TRUE, 
           transformation = "ld")
  
  # tabulation main results
  ra18 = tabgmm(a18)
  colnames(ra18) = c("ra18_c", "ra18_p")
  
    # merging databases
  table = bind_cols(ra11, ra12, ra13, ra14, ra15, ra16, ra17, ra18)
  
  return(table)
}

# defining types of gmm's equation
gmm1a = price ~ lag(price) + flight_hours + endo | lag(endo, 1:10) + lag(price, 2:10)
gmm1b = price ~ lag(price) + flight_hours + endo | lag(endo, 1:20) + lag(price, 2:20)
gmm1c = price ~ lag(price) + flight_hours + endo | lag(endo, 1:30) + lag(price, 2:30)
gmm1d = price ~ lag(price) + flight_hours + endo | lag(endo, 1:50) + lag(price, 2:50)  
gmm1e = price ~ lag(price) + flight_hours + endo | lag(endo, 1:99) + lag(price, 2:99) 

# executing all regression
resgmm1a = reggmm(gmm1a)
saveRDS(resgmm1a, "resgmm1a.rds")

resgmm1b = reggmm(gmm1b)
saveRDS(resgmm1b, "resgmm1b.rds")

resgmm1c = reggmm(gmm1c)
saveRDS(resgmm1c, "resgmm1c.rds")

resgmm1d = reggmm(gmm1d)
saveRDS(resgmm1d, "resgmm1d.rds")

resgmm1e = reggmm(gmm1e)
saveRDS(resgmm1e, "resgmm1e.rds")

```




