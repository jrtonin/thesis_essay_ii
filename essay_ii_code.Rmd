---
title: "Essay II"
author: "Jo√£o Ricardo Tonin"
date: "03/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "")
getwd()

{ 
  # Check if the packages that we need are installed
  want = c("tidyverse", "plm", "texreg", "lmtest", "tibble")
  have = want %in% rownames(installed.packages())
  # Install the packages that we miss
  if ( any(!have) ) { install.packages( want[!have] ) }
  # Load the packages
  junk <- lapply(want, library, character.only = T)
  # Remove the objects we created
  rm(have, want, junk)
} # Import packages

```

```{r reading_databases, include=FALSE, echo=TRUE}

# reading databases
LBASE1 = readRDS(url("https://github.com/jrtonin/thesis_data/raw/main/data/final/LBASE2c_Essay_II.rds"))
LBASE1c = readRDS(url("https://github.com/jrtonin/thesis_data/raw/main/data/final/LBASE1c_Essay_II.rds"))
LBASE2 = readRDS(url("https://github.com/jrtonin/thesis_data/raw/main/data/final/LBASE2_Essay_II.rds"))
LBASE2c = readRDS(url("https://github.com/jrtonin/thesis_data/raw/main/data/final/LBASE2c_Essay_II.rds"))

```

```{r databases, warning=FALSE, message=FALSE, error=FALSE, include=TRUE, echo = FALSE}

{
# organizing database
dLBASE1 = LBASE1 %>% 
  ungroup() %>%
  arrange(year, month, air_dep, air_arr, airline) %>%
  group_by(year, month) %>% 
  mutate(id = sequence(n()),
         time = paste0(year,"/", month))

# creating group indices' variable
dLBASE1$group = dLBASE1 %>% group_indices(time)

# transforming to panel data
dLBASE1 = pdata.frame(dLBASE1, index = c("id","time")) %>%
  ungroup() %>% arrange(year, month)

} # organizing LBASE1

```

```{r did_reg, include=FALSE}

# 2SLS

ols = plm(OLS, data = dLBASE1, effect = "time")
fe =  update(ols, effect = "twoways")
ivfe = update(fe, . ~ . | . -endo + z5)

# joining regression results
screenreg(list(ols   = ols,  fe   = fe, ivfe  = ivfe),
               digits = 3, omit.coef = "(Intercept)")

# tests 

## instrument relevance

# first stage: regress endogenous variable with all exogenous variables
fs = plm(FS, data = dLBASE1, effect = "twoways")

# second stage: regress first stage equation without z's variables
instrFtest = waldtest(fs, . ~ . -z5 )
print(instrFtest) # H0: instruments are irrelevants -> needs p_valor < 0,10 


## exogeneity test

# first stage: idem fs estimation

# second stage: regress normal equation with fs$residuals as independent variable
Hausman_reg = plm(HR, data = dLBASE1, effect = "twoways")
print(summary(Hausman_reg))

# third stage: execute Wu-Hausman exogeneity test
HausWutest = waldtest(Hausman_reg,.~.-fs$residuals)
print(HausWutest) # H0: residuals are irrelevants -> needs p_valor > 0.10


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ec2sls

w1 = plm(W1, data = dLBASE1, model = "within")
r1 = update(w1, model = "random", random.method = "nerlove",
            random.dfcor = c(3, 3), inst.method = "baltagi")

# Hausman test
phtest(w1, r1) # H1: one model is inconsistent - p_valor < 0,10 : within


# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# ht2sls

# ec
ht1r = plm(W1, data = dLBASE1, model = "random", 
           inst.method = "baltagi", random.method = "ht")

# w
ht1w = plm(W1, data = dLBASE1, model = "within", 
           inst.method = "baltagi", random.method = "ht")

# Hausman test
phtest(ht1w, ht1r)

# gmm

gmm1 = pgmm(pgmm, dLBASE1, model = "twosteps", effect="twoways", colapse=TRUE, transformation = "ld")

summary(gmm1)
coef(summary(gmm1))

mtest(gmm1, order = 1)
sargan(gmm1)
mtest(gmm1, order = 2, vcov = vcovHC)
```

```{r gmm_i, include=FALSE, error=TRUE}

# setting directory 
setwd("C:/TESE/GITHUB/thesis_essay_ii/results")

# editing function of organizing database
tabgmm = function(model){
  
  # extracting parameters
  param = as.data.frame(matrix(c(list(model$args$model, 
                                      model$args$effect, model$args$transformation)), 
                             ncol = 1, byrow = TRUE))
  colnames(param) = c("coef")
  row.names(param) = c("model", "effect", "transformation")
  param = param %>% 
    mutate(coef = as.character(coef))
  
  # extracting sargan test statistics
  sargan = sargan(model)
  sargan = as.data.frame(list(round(sargan$statistic, 3), round(sargan$p.value, 3)))
  colnames(sargan) = c("coef","pvalue")
  row.names(sargan) = c("sargan")
  
  # extracting mtest statistics
  mtest = mtest(model, order = 2)
  mtest = as.data.frame(list(round(mtest$statistic, 3), round(mtest$p.value, 3)))
  colnames(mtest) = c("coef","pvalue")
  row.names(mtest) = c("mtest")
  
  # extracting waldtest coef. statistics
  pwaldtest = pwaldtest(model, param = "coef")
  pwaldtest = as.data.frame(list(round(pwaldtest$statistic, 3), round(pwaldtest$p.value, 3)))
  colnames(pwaldtest) = c("coef","pvalue")
  row.names(pwaldtest) = c("Wald coef")
  
  # organizing database
  coef = as.data.frame(coef(summary(model))) %>% 
    mutate(pvalue = round(`Pr(>|z|)`,3),
           coef = round(Estimate,3)) %>%
    select(coef, pvalue) 
  
  # merging dataframes
  res = bind_rows(coef, sargan, mtest, pwaldtest) %>%
    mutate(coef = as.character(coef),
           pvalue = as.character(pvalue)) %>%
    bind_rows(param)
  
  return(res)
}

# editing function of regression gmm model
reggmm = function(equation){
  
  # regressing equation 1
  a11 = pgmm(equation, dLBASE1, model = "onestep", effect="individual")
  
  # tabulation main results
  ra11 = tabgmm(a11)
  colnames(ra11) = c("ra11_c", "ra11_p")
  
  # regressing equation 2
  a12 = pgmm(equation, dLBASE1, model = "onestep", effect="twoways")
  
  # tabulation main results
  ra12 = tabgmm(a12)
  colnames(ra12) = c("ra12_c", "ra12_p")
  
  # regressing equation 3
  a13 = pgmm(equation, dLBASE1, model = "twosteps", effect="individual")
  
  # tabulation main results
  ra13 = tabgmm(a13)
  colnames(ra13) = c("ra13_c", "ra13_p")
  
  # regressing equation 4
  a14 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways")
  
  # tabulation main results
  ra14 = tabgmm(a14)
  colnames(ra14) = c("ra14_c", "ra14_p")
  
  # regressing equation 5
  a15 = pgmm(equation, dLBASE1, model = "twosteps", effect="individual",colapse = TRUE)
  
  # tabulation main results
  ra15 = tabgmm(a15)
  colnames(ra15) = c("ra15_c", "ra15_p")
  
  # regressing equation 6
  a16 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways", colapse = TRUE)
  
  # tabulation main results
  ra16 = tabgmm(a16)
  colnames(ra16) = c("ra16_c", "ra16_p")
  
  # regressing equation 7
  a17 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways", colapse = TRUE, 
           transformation = "ld")
  
  # tabulation main results
  ra17 = tabgmm(a17)
  colnames(ra17) = c("ra17_c", "ra17_p")
  
  # regressing equation 7
  a18 = pgmm(equation, dLBASE1, model = "twosteps", effect="twoways", colapse = TRUE, 
           transformation = "ld")
  
  # tabulation main results
  ra18 = tabgmm(a18)
  colnames(ra18) = c("ra18_c", "ra18_p")
  
    # merging databases
  table = bind_cols(ra11, ra12, ra13, ra14, ra15, ra16, ra17, ra18)
  
  return(table)
}

# defining types of gmm's equation
gmm1a = price ~ lag(price) + flight_hours + endo | lag(endo, 1:10) + lag(price, 2:10)
gmm1b = price ~ lag(price) + flight_hours + endo | lag(endo, 1:20) + lag(price, 2:20)
gmm1c = price ~ lag(price) + flight_hours + endo | lag(endo, 1:30) + lag(price, 2:30)
gmm1d = price ~ lag(price) + flight_hours + endo | lag(endo, 1:50) + lag(price, 2:50)  
gmm1e = price ~ lag(price) + flight_hours + endo | lag(endo, 1:99) + lag(price, 2:99) 

# executing all regression
resgmm1a = reggmm(gmm1a)
saveRDS(resgmm1a, "resgmm1a.rds")

resgmm1b = reggmm(gmm1b)
saveRDS(resgmm1b, "resgmm1b.rds")

resgmm1c = reggmm(gmm1c)
saveRDS(resgmm1c, "resgmm1c.rds")

resgmm1d = reggmm(gmm1d)
saveRDS(resgmm1d, "resgmm1d.rds")

resgmm1e = reggmm(gmm1e)
saveRDS(resgmm1e, "resgmm1e.rds")


# defining types of gmm's equation
gmm2a = price ~ lag(price) + flight_hours + endo | lag(z1, 1:10) 
gmm2b = price ~ lag(price) + flight_hours + endo | lag(z1, 1:20) 
gmm2c = price ~ lag(price) + flight_hours + endo | lag(z1, 1:30) 
gmm2d = price ~ lag(price) + flight_hours + endo | lag(z1, 1:50) 
gmm2e = price ~ lag(price) + flight_hours + endo | lag(z1, 1:99)

# executing all regression
resgmm2a = reggmm(gmm2a)
saveRDS(resgmm2a, "resgmm2a.rds")

resgmm2b = reggmm(gmm2b)
saveRDS(resgmm2b, "resgmm2b.rds")

resgmm2c = reggmm(gmm2c)
saveRDS(resgmm2c, "resgmm2c.rds")

resgmm2d = reggmm(gmm2d)
saveRDS(resgmm2d, "resgmm2d.rds")

resgmm2e = reggmm(gmm2e)
saveRDS(resgmm2e, "resgmm2e.rds")


# defining types of gmm's equation
gmm3a = price ~ lag(price) + flight_hours + endo | lag(z5, 1:10) 
gmm3b = price ~ lag(price) + flight_hours + endo | lag(z5, 1:20) 
gmm3c = price ~ lag(price) + flight_hours + endo | lag(z5, 1:30) 
gmm3d = price ~ lag(price) + flight_hours + endo | lag(z5, 1:50) 
gmm3e = price ~ lag(price) + flight_hours + endo | lag(z5, 1:99)

# executing all regression
resgmm3a = reggmm(gmm3a)
saveRDS(resgmm3a, "resgmm3a.rds")

resgmm3b = reggmm(gmm3b)
saveRDS(resgmm3b, "resgmm3b.rds")

resgmm3c = reggmm(gmm3c)
saveRDS(resgmm3c, "resgmm3c.rds")

resgmm3d = reggmm(gmm3d)
saveRDS(resgmm3d, "resgmm3d.rds")

resgmm3e = reggmm(gmm3e)
saveRDS(resgmm3e, "resgmm3e.rds")


# defining types of gmm's equation
gmm4a = price ~ lag(price) + flight_hours + endo | lag(z1, 1:10) + lag(z5, 1:10)
gmm4b = price ~ lag(price) + flight_hours + endo | lag(z1, 1:20) + lag(z5, 1:20)
gmm4c = price ~ lag(price) + flight_hours + endo | lag(z1, 1:30) + lag(z5, 1:30)
gmm4d = price ~ lag(price) + flight_hours + endo | lag(z1, 1:50) + lag(z5, 1:50)
gmm4e = price ~ lag(price) + flight_hours + endo | lag(z1, 1:99) + lag(z5, 1:99)

# executing all regression
resgmm4a = reggmm(gmm4a)
saveRDS(resgmm4a, "resgmm4a.rds")

resgmm4b = reggmm(gmm4b)
saveRDS(resgmm4b, "resgmm4b.rds")

resgmm4c = reggmm(gmm4c)
saveRDS(resgmm4c, "resgmm4c.rds")

resgmm4d = reggmm(gmm4d)
saveRDS(resgmm4d, "resgmm4d.rds")

resgmm4e = reggmm(gmm4e)
saveRDS(resgmm4e, "resgmm4e.rds")

```




